<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KFSC — Shop Drawings & Model Log Dashboard</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">

  <!-- Your styles -->
  <link rel="stylesheet" href="./css/styles.css" />
</head>

<body>
<header>
  <h1>KFSC — Shop Drawings & Model Log Dashboard</h1>
  <div class="sub">Actionable: Aging + Bottlenecks + Group Board • Click charts/heatmap to filter • Shareable URL</div>
</header>

<nav class="topnav">
  <button class="navBtn active" data-page="overview" type="button">Overview</button>
  <button class="navBtn" data-page="operations" type="button">Operations</button>
  <button class="navBtn" data-page="data" type="button">Data</button>
</nav>

<div class="wrap">
  <div class="card">
    <div class="controls">
      <div class="ctrl">
        <label>Upload CSV</label>
        <input id="fileInput" type="file" accept=".csv" />
      </div>

      <div class="ctrl">
        <label>Quick Search (Drawing No / Description / Workflow)</label>
        <input id="searchBox" type="text" placeholder="Type to filter..." />
      </div>

      <div class="ctrl">
        <label>Level</label>
        <select id="levelFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Zone</label>
        <select id="zoneFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Status-VP</label>
        <select id="statusVpFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Discipline</label>
        <select id="disciplineFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Curr. Code</label>
        <select id="currCodeFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Actions</label>
        <div class="twoActions">
          <button id="resetBtn" class="secondary" type="button">Reset Filters</button>
          <button id="exportBtn" type="button">Export Filtered CSV</button>
          <button id="exportGroupsBtn" class="ghost" type="button">Export Group Board CSV</button>
          <button id="copyLinkBtn" class="ghost" type="button">Copy Share Link</button>
        </div>
        <div class="hint">Tip: click bars/heatmap cells to filter. Filters are stored in URL.</div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="small">Active filters:</div>
    <div id="activeFilters" class="activeFilters" style="margin-top:8px;"></div>
  </div>

  <div style="height:12px"></div>

  <!-- Debug Panel (optional) -->
  <div class="debugBox" id="debugBox" style="display:none;">
    <div class="bar">
      <span class="tag"><b>Debug</b> — CSV load/parse logs</span>
      <button type="button" id="dbgClearBtn">Clear</button>
      <button type="button" id="dbgHideBtn">Hide</button>
    </div>
    <pre id="dbgOut"></pre>
  </div>

  <section class="page active" data-page="overview">
    <div class="pageTitle">Overview</div>

    <div class="heroRow">
      <div class="card">
        <h2>KPIs Snapshot</h2>
        <div class="row cols-2">
          <div class="kpi"><div class="val" id="kpiTotal">—</div><div class="lbl">Total rows</div></div>
          <div class="kpi"><div class="val" id="kpiSubmitted">—</div><div class="lbl">With Workflow No.</div></div>
          <div class="kpi"><div class="val" id="kpiCodeB">—</div><div class="lbl">Curr. Code = B</div></div>
          <div class="kpi"><div class="val" id="kpiCodeC">—</div><div class="lbl">Curr. Code = C</div></div>
          <div class="kpi"><div class="val" id="kpiNotStarted">—</div><div class="lbl">Status-VP contains "Not Started"</div></div>
        </div>
        <div class="footer small">KPIs based on current filters.</div>
      </div>

      <div class="card insight">
        <h2>Daily Focus</h2>
        <div>
          <div class="metric" id="kpiHighRisk">—</div>
          <div class="caption">Items over 14 days old</div>
        </div>
        <div>
          <div class="metric" id="kpiReadyToClose">—</div>
          <div class="caption">Items with SLA = OK</div>
        </div>
        <div class="small">Use this to align standups and close open loops.</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="row cols-3">
      <div class="card">
        <h2>Distribution — Status-VP</h2>
        <canvas id="chartStatus"></canvas>
        <div class="clickHint">Click a bar to filter Status-VP.</div>
      </div>

      <div class="card">
        <h2>Distribution — Current Code</h2>
        <canvas id="chartCode"></canvas>
        <div class="clickHint">Click a bar to filter Curr. Code.</div>
      </div>

      <div class="card">
        <h2>SLA Status Mix</h2>
        <canvas id="chartSla"></canvas>
        <div class="clickHint">Tracks SLA buckets from AgingDays.</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="row cols-3">
      <div class="card">
        <h2>Heatmap — Level × Zone</h2>
        <div id="heatmap" class="small">Upload CSV to render…</div>
        <div class="clickHint">Click a cell to filter Level + Zone.</div>
      </div>

      <div class="card">
        <h2>Aging Buckets</h2>
        <canvas id="chartAging"></canvas>
        <div class="clickHint">Aging in days (0-7, 8-14, 15-30, 31+).</div>
      </div>

      <div class="card">
        <h2>Discipline Mix</h2>
        <canvas id="chartDiscipline"></canvas>
        <div class="clickHint">Highlights where volume clusters.</div>
      </div>
    </div>
  </section>

  <section class="page" data-page="operations">
    <div class="pageTitle">Operations</div>
    <div class="row cols-2">
      <div class="card">
        <h2>Action Board — Top Bottlenecks (Oldest 20)</h2>
        <div class="small">
          Aging uses best available date (priority):
          <span class="mono">Curr. Code Date → Consult. Rep → Consult. Sub → SBG Approval/Sub</span>.
        </div>
        <div style="height:10px"></div>
        <div id="bottlenecks" class="bList"></div>
      </div>

      <div class="card">
        <h2>Group Board (worst-first)</h2>
        <div class="small">
          Grouping: <span class="mono">Level + Zone + Discipline + Sub-Discipline</span>
        </div>
        <div style="height:10px"></div>
        <div id="groupBoard"></div>
        <div class="footer small" id="loadInfo"></div>
      </div>
    </div>
  </section>

  <section class="page" data-page="data">
    <div class="pageTitle">Data</div>
    <div class="card">
      <h2>Interactive Table</h2>
      <div class="small">Now includes <b>AgingDays</b> and <b>SLA</b> columns. Frozen first columns for daily use.</div>
      <div style="height:10px"></div>
      <div id="table"></div>
    </div>
  </section>
</div>

<!-- Libraries (global) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- App (module) -->
<script type="module" src="./js/app.js"></script>
</body>
</html>
