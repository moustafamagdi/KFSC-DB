<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KFSC — Shop Drawings & Model Log Dashboard</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    :root { --gap: 12px; }
    body { font-family: "Inter", system-ui, Segoe UI, Arial; margin: 0; background: #f3f5fb; color: #0f172a; }
    header { padding: 16px 18px 8px; background: #0f172a; color: #fff; box-shadow: 0 8px 24px rgba(15,23,42,.18); }
    header h1 { margin: 0; font-size: 17px; font-weight: 700; letter-spacing: .2px; }
    header .sub { opacity: .75; font-size: 12px; margin-top: 6px; }

    .topnav { display: flex; gap: 8px; padding: 10px 18px 16px; background: #0f172a; }
    .topnav button {
      border: 1px solid rgba(148,163,184,.35); background: rgba(30,41,59,.65); color: #e2e8f0;
      padding: 8px 14px; border-radius: 999px; font-size: 12px; cursor: pointer;
    }
    .topnav button.active { background: #e2e8f0; color: #0f172a; font-weight: 700; }

    .wrap { padding: 18px; }
    .row { display: grid; gap: var(--gap); }
    .row.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .row.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 1100px) { .row.cols-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 650px) { .row.cols-4, .row.cols-3, .row.cols-2 { grid-template-columns: 1fr; } }

    .card { background: #fff; border-radius: 16px; padding: 14px; box-shadow: 0 1px 12px rgba(15,23,42,.08); border: 1px solid #eef2f7; }
    .card h2 { margin: 0 0 10px; font-size: 13px; color: #0f172a; }
    .kpi { display: flex; align-items: baseline; gap: 10px; }
    .kpi .val { font-size: 26px; font-weight: 800; color: #0f172a; }
    .kpi .lbl { font-size: 12px; opacity: .7; }

    .controls { display: grid; gap: 10px; grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr; align-items: end; }
    @media (max-width: 1100px) { .controls { grid-template-columns: 1fr 1fr; } }
    .ctrl label { display: block; font-size: 11px; opacity: .7; margin-bottom: 6px; }
    .ctrl input, .ctrl select, .ctrl button {
      width: 100%; padding: 9px 10px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff;
      font-size: 13px; box-shadow: inset 0 1px 0 rgba(15,23,42,.04);
    }
    .ctrl button { cursor: pointer; background: #0f172a; color: #fff; border: 0; }
    .ctrl button.secondary { background: #334155; }
    .ctrl button.ghost { background: #eef2ff; color: #0f172a; border: 1px solid #e5e7eb; }
    .hint { font-size: 12px; opacity: .7; margin-top: 8px; }

    canvas { width: 100% !important; height: 260px !important; }

    #table { border-radius: 12px; overflow: hidden; }
    .small { font-size: 12px; opacity: .75; }

    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; background: #eef2ff; font-size: 11px; }
    .danger { background: #fee2e2; color: #991b1b; }
    .warn { background: #fef3c7; color: #92400e; }
    .ok { background: #dcfce7; color: #166534; }
    .muted { background: #f3f4f6; color: #475569; }

    .footer { margin-top: 10px; font-size: 12px; opacity: .75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .twoActions { display:flex; gap:10px; flex-wrap:wrap; }
    .bList { display:grid; gap:10px; }
    .bItem { padding:10px; border:1px solid #eef2f7; border-radius:12px; }
    .bTitle { font-size:12px; font-weight:750; }
    .bDesc { font-size:12px; opacity:.8; margin-top:4px; }
    .bMeta { font-size:12px; opacity:.75; margin-top:6px; }
    .clickHint { font-size: 12px; opacity: .7; margin-top: 6px; }
    .divider { height: 1px; background: #eef2f7; margin: 10px 0; }

    .activeFilters { display:flex; gap:8px; flex-wrap:wrap; }
    .page { display: none; }
    .page.active { display: block; }
    .pageTitle { font-size: 15px; font-weight: 700; color: #0f172a; margin: 6px 0 12px; }
    .heroRow { display: grid; gap: var(--gap); grid-template-columns: 2fr 1fr; }
    @media (max-width: 1100px) { .heroRow { grid-template-columns: 1fr; } }
    .insight { display: grid; gap: 8px; }
    .insight .metric { font-size: 20px; font-weight: 750; }
    .insight .caption { font-size: 12px; opacity: .7; }
  </style>
</head>

<body>
<header>
  <h1>KFSC — Shop Drawings & Model Log Dashboard</h1>
  <div class="sub">Actionable: Aging + Bottlenecks + Group Board • Click charts/heatmap to filter • Shareable URL</div>
</header>
<nav class="topnav">
  <button class="navBtn active" data-page="overview" type="button">Overview</button>
  <button class="navBtn" data-page="operations" type="button">Operations</button>
  <button class="navBtn" data-page="data" type="button">Data</button>
</nav>

<div class="wrap">
  <div class="card">
    <div class="controls">
      <div class="ctrl">
        <label>Upload CSV</label>
        <input id="fileInput" type="file" accept=".csv" />
      </div>

      <div class="ctrl">
        <label>Quick Search (Drawing No / Description / Workflow)</label>
        <input id="searchBox" type="text" placeholder="Type to filter..." />
      </div>

      <div class="ctrl">
        <label>Level</label>
        <select id="levelFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Zone</label>
        <select id="zoneFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Status-VP</label>
        <select id="statusVpFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Discipline</label>
        <select id="disciplineFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Curr. Code</label>
        <select id="currCodeFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Actions</label>
        <div class="twoActions">
          <button id="resetBtn" class="secondary" type="button">Reset Filters</button>
          <button id="exportBtn" type="button">Export Filtered CSV</button>
          <button id="exportGroupsBtn" class="ghost" type="button">Export Group Board CSV</button>
          <button id="copyLinkBtn" class="ghost" type="button">Copy Share Link</button>
        </div>
        <div class="hint">Tip: click bars/heatmap cells to filter. Filters are stored in URL.</div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="small">Active filters:</div>
    <div id="activeFilters" class="activeFilters" style="margin-top:8px;"></div>
  </div>

  <div style="height:12px"></div>

  <section class="page active" data-page="overview">
    <div class="pageTitle">Overview</div>
    <div class="heroRow">
      <div class="card">
        <h2>KPIs Snapshot</h2>
        <div class="row cols-2">
          <div class="kpi"><div class="val" id="kpiTotal">—</div><div class="lbl">Total rows</div></div>
          <div class="kpi"><div class="val" id="kpiSubmitted">—</div><div class="lbl">With Workflow No.</div></div>
          <div class="kpi"><div class="val" id="kpiCodeB">—</div><div class="lbl">Curr. Code = B</div></div>
          <div class="kpi"><div class="val" id="kpiCodeC">—</div><div class="lbl">Curr. Code = C</div></div>
          <div class="kpi"><div class="val" id="kpiNotStarted">—</div><div class="lbl">Status-VP contains "Not Started"</div></div>
        </div>
        <div class="footer small">KPIs based on current filters.</div>
      </div>
      <div class="card insight">
        <h2>Daily Focus</h2>
        <div>
          <div class="metric" id="kpiHighRisk">—</div>
          <div class="caption">Items over 14 days old</div>
        </div>
        <div>
          <div class="metric" id="kpiReadyToClose">—</div>
          <div class="caption">Items with SLA = OK</div>
        </div>
        <div class="small">Use this to align standups and close open loops.</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="row cols-3">
      <div class="card">
        <h2>Distribution — Status-VP</h2>
        <canvas id="chartStatus"></canvas>
        <div class="clickHint">Click a bar to filter Status-VP.</div>
      </div>

      <div class="card">
        <h2>Distribution — Current Code</h2>
        <canvas id="chartCode"></canvas>
        <div class="clickHint">Click a bar to filter Curr. Code.</div>
      </div>

      <div class="card">
        <h2>SLA Status Mix</h2>
        <canvas id="chartSla"></canvas>
        <div class="clickHint">Tracks SLA buckets from AgingDays.</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="row cols-3">
      <div class="card">
        <h2>Heatmap — Level × Zone</h2>
        <div id="heatmap" class="small">Upload CSV to render…</div>
        <div class="clickHint">Click a cell to filter Level + Zone.</div>
      </div>

      <div class="card">
        <h2>Aging Buckets</h2>
        <canvas id="chartAging"></canvas>
        <div class="clickHint">Aging in days (0-7, 8-14, 15-30, 31+).</div>
      </div>

      <div class="card">
        <h2>Discipline Mix</h2>
        <canvas id="chartDiscipline"></canvas>
        <div class="clickHint">Highlights where volume clusters.</div>
      </div>
    </div>
  </section>

  <section class="page" data-page="operations">
    <div class="pageTitle">Operations</div>
    <div class="row cols-2">
      <div class="card">
        <h2>Action Board — Top Bottlenecks (Oldest 20)</h2>
        <div class="small">
          Aging uses best available date (priority): <span class="mono">Curr. Code Date → Consult. Rep → Consult. Sub → SBG Approval/Sub</span>.
        </div>
        <div style="height:10px"></div>
        <div id="bottlenecks" class="bList"></div>
      </div>

      <div class="card">
        <h2>Group Board (worst-first)</h2>
        <div class="small">
          Grouping: <span class="mono">Level + Zone + Discipline + Sub-Discipline</span>
        </div>
        <div style="height:10px"></div>
        <div id="groupBoard"></div>
        <div class="footer small" id="loadInfo"></div>
      </div>
    </div>
  </section>

  <section class="page" data-page="data">
    <div class="pageTitle">Data</div>
    <div class="card">
      <h2>Interactive Table</h2>
      <div class="small">Now includes <b>AgingDays</b> and <b>SLA</b> columns. Frozen first columns for daily use.</div>
      <div style="height:10px"></div>
      <div id="table"></div>
    </div>
  </section>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // ---------------------------
  // Debug helper
  // ---------------------------
  const DBG = true;
  function logGroup(title, fn){
    if(!DBG) return;
    console.groupCollapsed(title);
    try { fn && fn(); } finally { console.groupEnd(); }
  }

  // ---------------------------
  // Helpers
  // ---------------------------
  const LS_KEY = "kfsc_shopdrawings_last_csv_v3";

  function norm(v){
    if(v === null || v === undefined) return "";
    const s = String(v).trim();
    if(s === "-" || s.toLowerCase() === "nan") return "";
    return s;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function uniqSorted(arr){
    return [...new Set(arr.filter(x => x !== ""))].sort((a,b) => a.localeCompare(b, undefined, {numeric:true, sensitivity:"base"}));
  }

  function pill(text, cls){
    return `<span class="pill ${cls||""}">${escapeHtml(text)}</span>`;
  }

  function parseDateSafe(v){
    const s = norm(v);
    if(!s) return null;
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
    return null;
  }

  function daysBetween(d1, d2){
    const ms = d2.getTime() - d1.getTime();
    return Math.floor(ms / (1000*60*60*24));
  }

  function countBy(rows, key){
    const m = new Map();
    rows.forEach(r => {
      const k = norm(r[key]) || "(blank)";
      m.set(k, (m.get(k)||0) + 1);
    });
    return [...m.entries()].sort((a,b) => b[1]-a[1]);
  }

  // ---------------------------
  // State
  // ---------------------------
  let rawRows = [];
  let filteredRows = [];
  let table = null;
  let tableReady = false;

  let chartStatus = null;
  let chartCode = null;
  let chartSla = null;
  let chartAging = null;
  let chartDiscipline = null;

  let lastHeaderLine = null;

  const els = {
    fileInput: document.getElementById("fileInput"),
    searchBox: document.getElementById("searchBox"),
    levelFilter: document.getElementById("levelFilter"),
    zoneFilter: document.getElementById("zoneFilter"),
    statusVpFilter: document.getElementById("statusVpFilter"),
    disciplineFilter: document.getElementById("disciplineFilter"),
    currCodeFilter: document.getElementById("currCodeFilter"),

    resetBtn: document.getElementById("resetBtn"),
    exportBtn: document.getElementById("exportBtn"),
    exportGroupsBtn: document.getElementById("exportGroupsBtn"),
    copyLinkBtn: document.getElementById("copyLinkBtn"),

    activeFilters: document.getElementById("activeFilters"),

    kpiTotal: document.getElementById("kpiTotal"),
    kpiSubmitted: document.getElementById("kpiSubmitted"),
    kpiCodeB: document.getElementById("kpiCodeB"),
    kpiCodeC: document.getElementById("kpiCodeC"),
    kpiNotStarted: document.getElementById("kpiNotStarted"),
    kpiHighRisk: document.getElementById("kpiHighRisk"),
    kpiReadyToClose: document.getElementById("kpiReadyToClose"),

    chartStatusCanvas: document.getElementById("chartStatus"),
    chartCodeCanvas: document.getElementById("chartCode"),
    chartSlaCanvas: document.getElementById("chartSla"),
    chartAgingCanvas: document.getElementById("chartAging"),
    chartDisciplineCanvas: document.getElementById("chartDiscipline"),

    heatmap: document.getElementById("heatmap"),
    bottlenecks: document.getElementById("bottlenecks"),
    groupBoard: document.getElementById("groupBoard"),
    loadInfo: document.getElementById("loadInfo"),
  };

  // ---------------------------
  // Header detection
  // ---------------------------
  function detectHeaderRow(rows){
    const mustHave = ["S.N.", "Drawing No.", "Description"];
    const shouldHave = ["Level", "Zone", "Discipline", "Status-VP", "Curr. Code", "Workflow No."];

    for(let i=0; i<Math.min(rows.length, 200); i++){
      const row = (rows[i] || []).map(v => (v ?? "").toString().replace(/^\uFEFF/, "").trim());

      const nonEmpty = row.filter(cell => cell !== "").length;
      if(nonEmpty < 3) continue;

      const mustHits = mustHave.filter(h => row.includes(h)).length;
      const shouldHits = shouldHave.filter(h => row.includes(h)).length;
      if(mustHits === mustHave.length && shouldHits >= 2){
        return i;
      }
    }
    return -1;
  }

  function makeHeadersUnique(fields){
    const seen = new Map();
    return (fields || []).map((f, idx) => {
      const base = norm(f) || `Unnamed_${idx}`;
      const key = base.toLowerCase();
      const n = (seen.get(key) || 0) + 1;
      seen.set(key, n);
      return n === 1 ? base : `${base} (${n})`;
    });
  }

  // ---------------------------
  // Aging & SLA
  // ---------------------------
  function getBestTouchDate(row){
    const priorityCols = [
      "Curr. Code Date",
      "Consult. Rep (02)", "Consult. Rep (01)", "Consult. Rep (00)",
      "Consult. Sub (02)", "Consult. Sub (01)", "Consult. Sub (00)",
      "SBG Approval (02)", "SBG Approval (01)", "SBG Approval (0)",
      "SBG Sub (02)", "SBG Sub (01)", "SBG Sub (00)",
    ];

    for(const c of priorityCols){
      if(row[c] !== undefined){
        const d = parseDateSafe(row[c]);
        if(d) return { date: d, source: c };
      }
    }
    return null;
  }

  function computeAgingAndSLA(row){
    const now = new Date();
    const last = getBestTouchDate(row);
    if(!last) return { agingDays: "", agingSource: "", sla: "Unknown" };

    const age = daysBetween(last.date, now);
    let sla = "OK";
    if(age > 30) sla = "Over 30d";
    else if(age > 14) sla = "Over 14d";
    else if(age > 7) sla = "Over 7d";

    return { agingDays: age, agingSource: last.source, sla };
  }

  // ---------------------------
  // URL filters
  // ---------------------------
  function getFiltersFromUI(){
    return {
      q: norm(els.searchBox.value),
      level: norm(els.levelFilter.value),
      zone: norm(els.zoneFilter.value),
      statusVp: norm(els.statusVpFilter.value),
      discipline: norm(els.disciplineFilter.value),
      code: norm(els.currCodeFilter.value),
    };
  }

  function setFiltersToUI(f){
    els.searchBox.value = f.q || "";
    els.levelFilter.value = f.level || "";
    els.zoneFilter.value = f.zone || "";
    els.statusVpFilter.value = f.statusVp || "";
    els.disciplineFilter.value = f.discipline || "";
    els.currCodeFilter.value = f.code || "";
  }

  function writeFiltersToURL(){
    const f = getFiltersFromUI();
    const params = new URLSearchParams();
    Object.entries(f).forEach(([k,v]) => { if(v) params.set(k, v); });
    const newUrl = `${location.pathname}?${params.toString()}`;
    history.replaceState(null, "", newUrl);
  }

  function readFiltersFromURL(){
    const p = new URLSearchParams(location.search);
    return {
      q: p.get("q") || "",
      level: p.get("level") || "",
      zone: p.get("zone") || "",
      statusVp: p.get("statusVp") || "",
      discipline: p.get("discipline") || "",
      code: p.get("code") || "",
    };
  }

  function renderActiveFilters(){
    const f = getFiltersFromUI();
    const chips = [];
    if(f.q) chips.push(pill(`Search: ${f.q}`, "muted"));
    if(f.level) chips.push(pill(`Level: ${f.level}`, "muted"));
    if(f.zone) chips.push(pill(`Zone: ${f.zone}`, "muted"));
    if(f.statusVp) chips.push(pill(`Status-VP: ${f.statusVp}`, "muted"));
    if(f.discipline) chips.push(pill(`Discipline: ${f.discipline}`, "muted"));
    if(f.code) chips.push(pill(`Curr Code: ${f.code}`, "muted"));
    els.activeFilters.innerHTML = chips.length ? chips.join(" ") : pill("None", "muted");
  }

  async function copyShareLink(){
    const url = location.href;
    try {
      await navigator.clipboard.writeText(url);
      alert("Link copied ✅");
    } catch(e){
      prompt("Copy this link:", url);
    }
  }

  // ---------------------------
  // Load CSV
  // ---------------------------
  function loadCsvText(csvText){
    logGroup("CSV Load: start", () => {
      console.log("CSV chars:", (csvText || "").length);
      console.log("CSV first 400 chars:\n", String(csvText || "").slice(0, 400));
    });

    try { localStorage.setItem(LS_KEY, csvText); } catch(e) {}

    Papa.parse(csvText, {
      header: false,
      skipEmptyLines: true,
      dynamicTyping: false,
      complete: (results) => {

        logGroup("CSV Parse: raw rows", () => {
          const rows0 = results.data || [];
          console.log("Total parsed rows:", rows0.length);
          console.log("Row[0] (array):", rows0[0]);
          console.log("Row[1] (array):", rows0[1]);
          console.log("Row[2] (array):", rows0[2]);
          console.log("Row[0] length:", rows0[0]?.length, "Row[1] length:", rows0[1]?.length);
          console.table(rows0.slice(0, 15).map((r,i)=>({
            i,
            len: r?.length ?? 0,
            firstNonEmptyIdx: (r||[]).findIndex(x => norm(x) !== ""),
            preview: (r||[]).slice(0,8).map(x=>norm(x)).join(" | ")
          })));
        });

        const rows = results.data || [];
        const headerIndex = detectHeaderRow(rows);

        logGroup("Header Detection", () => {
          console.log("Detected headerIndex:", headerIndex, " (line:", headerIndex + 1, ")");
          console.log("Header row raw array:", rows[headerIndex]);
          console.log("Header row preview:", (rows[headerIndex] || []).slice(0, 20));
        });

        if(headerIndex === -1){
          alert("Header row not found. Ensure CSV contains: S.N., Drawing No., Description, ...");
          console.log("First 30 rows:", rows.slice(0,30));
          return;
        }

        lastHeaderLine = headerIndex + 1;
        const cleanRows = rows.slice(headerIndex);
        const rawFields = cleanRows[0] || [];
        const uniqueFields = makeHeadersUnique(rawFields);

        logGroup("Header Fields (mapped)", () => {
          console.log("Header fields count:", uniqueFields.length);
          console.log("First 25 fields:", uniqueFields.slice(0,25));
          console.log(
            "Index of S.N.:", uniqueFields.indexOf("S.N."),
            "| Drawing No.:", uniqueFields.indexOf("Drawing No."),
            "| Description:", uniqueFields.indexOf("Description")
          );
        });

        // Skip blank rows between header and data
        let dataStartIndex = 1;
        while(dataStartIndex < cleanRows.length && cleanRows[dataStartIndex].every(cell => !norm(cell))){
          dataStartIndex++;
        }

        logGroup("Data Start", () => {
          console.log("dataStartIndex (within cleanRows):", dataStartIndex, " => file line:", headerIndex + dataStartIndex + 1);
          console.log("First data row raw array:", cleanRows[dataStartIndex]);
          console.log("First data row preview:", (cleanRows[dataStartIndex]||[]).slice(0,12));
        });

        rawRows = cleanRows.slice(dataStartIndex).map(row => {
          const out = {};
          uniqueFields.forEach((f, i) => { out[f] = row[i] ?? ""; });

          const computed = computeAgingAndSLA(out);
          out["AgingDays"] = computed.agingDays;
          out["AgingSource"] = computed.agingSource;
          out["SLA"] = computed.sla;

          return out;
        });

        rawRows = rawRows.filter(r => Object.values(r).some(v => norm(v)));

        logGroup("Sanity Check: first rows for S.N./Drawing No.", () => {
          const sample = rawRows.slice(0, 15).map((r,i)=>({
            i,
            SN: norm(r["S.N."]),
            DrawingNo: norm(r["Drawing No."]),
            Description: norm(r["Description"]).slice(0, 60),
            Level: norm(r["Level"]),
            Zone: norm(r["Zone"]),
          }));
          console.table(sample);

          const emptySN = rawRows.slice(0, 200).filter(r => !norm(r["S.N."])).length;
          const emptyDN = rawRows.slice(0, 200).filter(r => !norm(r["Drawing No."])).length;
          console.warn(`In first 200 rows => empty S.N.: ${emptySN}, empty Drawing No.: ${emptyDN}`);

          if(emptySN > 0 || emptyDN > 0){
            console.warn("If your CSV actually contains S.N. and Drawing No. values, then your data rows are offset (extra leading commas) or the header is not the real header.");
            console.warn("Example: If a data row begins with ',,Description...' then S.N. and DrawingNo will appear empty (because they are empty in the file).");
          }
        });

        buildUIFromData(uniqueFields.concat(["AgingDays","AgingSource","SLA"]));
        applyAll();

        els.loadInfo.innerHTML =
          `Loaded <b>${rawRows.length.toLocaleString()}</b> rows • Header line <b>${lastHeaderLine}</b>.`;
      },
      error: (err) => {
        alert("CSV parse error: " + err);
        console.error(err);
      }
    });
  }

  // ---------------------------
  // Build UI + Tabulator
  // ---------------------------
  function buildUIFromData(allKeys){
    const levels = uniqSorted(rawRows.map(r => norm(r["Level"])));
    const zones = uniqSorted(rawRows.map(r => norm(r["Zone"])));
    const statusVp = uniqSorted(rawRows.map(r => norm(r["Status-VP"])));
    const discs = uniqSorted(rawRows.map(r => norm(r["Discipline"])));
    const codes = uniqSorted(rawRows.map(r => norm(r["Curr. Code"])));

    els.levelFilter.innerHTML = `<option value="">All</option>` + levels.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    els.zoneFilter.innerHTML = `<option value="">All</option>` + zones.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    els.statusVpFilter.innerHTML = `<option value="">All</option>` + statusVp.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    els.disciplineFilter.innerHTML = `<option value="">All</option>` + discs.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    els.currCodeFilter.innerHTML = `<option value="">All</option>` + codes.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");

    // Apply URL filters after options exist
    setFiltersToUI(readFiltersFromURL());

    const preferred = [
      "S.N.", "Drawing No.", "Description",
      "Level", "Zone", "Discipline", "Sub-Discipline",
      "Status-SBG", "Status-VP", "Curr. Code",
      "AgingDays", "SLA",
      "Curr. Code Date", "Workflow No.", "Remarks"
    ];

    const colsOrdered = preferred.filter(c => allKeys.includes(c))
      .concat(allKeys.filter(k => !preferred.includes(k)));

    const tabCols = colsOrdered.map(c => {
      const col = {
        title: c,
        field: c,
        hozAlign: "left",
        headerFilter: false,
        widthGrow: 2,
        formatter: (cell) => {
          const v = norm(cell.getValue());
          if(!v) return "";
          if(c === "Curr. Code"){
            const cls = v === "C" ? "danger" : (v === "B" ? "warn" : (v === "QA" ? "ok" : ""));
            return pill(v, cls);
          }
          if(c === "SLA"){
            const cls = v.includes("30") ? "danger" : (v.includes("14") ? "warn" : (v.includes("7") ? "warn" : (v==="OK" ? "ok" : "muted")));
            return pill(v, cls);
          }
          if(c === "AgingDays"){
            const n = Number(v);
            if(Number.isFinite(n)){
              const cls = n > 30 ? "danger" : (n > 14 ? "warn" : (n > 7 ? "warn" : "ok"));
              return pill(String(n), cls);
            }
          }
          if(c === "Status-VP"){
            const low = v.toLowerCase();
            if(low.includes("not started")) return pill(v, "danger");
            if(low.includes("on hold")) return pill(v, "warn");
            return escapeHtml(v);
          }
          return escapeHtml(v);
        }
      };

      if(["S.N.","Drawing No.","Description"].includes(c)) col.frozen = true;
      if(c === "AgingDays") col.hozAlign = "right";

      return col;
    });

    if(table){
      table.destroy();
      table = null;
      tableReady = false;
    }

    table = new Tabulator("#table", {
      data: [],
      columns: tabCols,

      // ✅ IMPORTANT FIX: do NOT treat dots in field names as nested paths
      nestedFieldSeparator: false,

      layout: "fitDataStretch",
      height: "auto",
      maxHeight: "540px",
      pagination: "local",
      paginationSize: 25,
      paginationSizeSelector: [25, 50, 100, 200],
      paginationCounter: "rows",
      movableColumns: true,
      resizableColumnFit: true,
      placeholder: "No data (check filters)…",
    });

    table.on("tableBuilt", () => {
      tableReady = true;
      updateTable();
    });
  }

  // ---------------------------
  // Apply filters + refresh
  // ---------------------------
  function applyAll(){
    const f = getFiltersFromUI();
    const q = norm(f.q).toLowerCase();

    filteredRows = rawRows.filter(r => {
      if(f.level && norm(r["Level"]) !== f.level) return false;
      if(f.zone && norm(r["Zone"]) !== f.zone) return false;
      if(f.statusVp && norm(r["Status-VP"]) !== f.statusVp) return false;
      if(f.discipline && norm(r["Discipline"]) !== f.discipline) return false;
      if(f.code && norm(r["Curr. Code"]) !== f.code) return false;

      if(q){
        const hay = [
          r["Drawing No."], r["Description"], r["Workflow No."],
          r["Workflow No. (01)"], r["Workflow No. (02)"],
          r["Status-VP"], r["Status-SBG"], r["Remarks"]
        ].map(norm).join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    updateKPIs();
    updateCharts();
    updateHeatmap();
    updateBottlenecks();
    updateGroupBoard();
    updateTable();

    renderActiveFilters();
    writeFiltersToURL();
  }

  // ---------------------------
  // KPIs
  // ---------------------------
  function updateKPIs(){
    const rows = filteredRows;
    const total = rows.length;
    const withWF = rows.filter(r => norm(r["Workflow No."]) || norm(r["Workflow No. (01)"]) || norm(r["Workflow No. (02)"])).length;
    const codeB = rows.filter(r => norm(r["Curr. Code"]) === "B").length;
    const codeC = rows.filter(r => norm(r["Curr. Code"]) === "C").length;
    const notStarted = rows.filter(r => norm(r["Status-VP"]).toLowerCase().includes("not started")).length;
    const highRisk = rows.filter(r => Number(r["AgingDays"]) > 14).length;
    const readyToClose = rows.filter(r => norm(r["SLA"]) === "OK").length;

    els.kpiTotal.textContent = total.toLocaleString();
    els.kpiSubmitted.textContent = withWF.toLocaleString();
    els.kpiCodeB.textContent = codeB.toLocaleString();
    els.kpiCodeC.textContent = codeC.toLocaleString();
    els.kpiNotStarted.textContent = notStarted.toLocaleString();
    els.kpiHighRisk.textContent = highRisk.toLocaleString();
    els.kpiReadyToClose.textContent = readyToClose.toLocaleString();
  }

  // ---------------------------
  // Charts
  // ---------------------------
  function renderBarChart(chartRef, canvas, labels, data, onClick){
    if(chartRef) chartRef.destroy();
    const c = new Chart(canvas, {
      type: "bar",
      data: { labels, datasets: [{ label: "", data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } },
        onClick: (evt, elements) => {
          if(!elements || !elements.length) return;
          const idx = elements[0].index;
          const label = labels[idx];
          onClick(label);
        }
      }
    });
    return c;
  }

  function renderDonutChart(chartRef, canvas, labels, data, colors){
    if(chartRef) chartRef.destroy();
    return new Chart(canvas, {
      type: "doughnut",
      data: { labels, datasets: [{ data, backgroundColor: colors }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "bottom" } },
        cutout: "70%",
      }
    });
  }

  function updateCharts(){
    if(!filteredRows.length) return;

    const topStatus = countBy(filteredRows, "Status-VP").slice(0,10);
    const topCode = countBy(filteredRows, "Curr. Code").slice(0,10);
    const topDiscipline = countBy(filteredRows, "Discipline").slice(0,8);

    const slaMap = new Map();
    filteredRows.forEach(r => {
      const k = norm(r["SLA"]) || "Unknown";
      slaMap.set(k, (slaMap.get(k) || 0) + 1);
    });
    const slaLabels = [...slaMap.keys()];
    const slaData = [...slaMap.values()];

    const agingBuckets = [
      { label: "0-7", test: v => v <= 7 },
      { label: "8-14", test: v => v > 7 && v <= 14 },
      { label: "15-30", test: v => v > 14 && v <= 30 },
      { label: "31+", test: v => v > 30 },
    ];
    const agingData = agingBuckets.map(b =>
      filteredRows.filter(r => Number.isFinite(Number(r["AgingDays"])) && b.test(Number(r["AgingDays"]))).length
    );

    chartStatus = renderBarChart(
      chartStatus,
      els.chartStatusCanvas,
      topStatus.map(x => x[0]),
      topStatus.map(x => x[1]),
      (label) => { els.statusVpFilter.value = (label === "(blank)") ? "" : label; applyAll(); }
    );

    chartCode = renderBarChart(
      chartCode,
      els.chartCodeCanvas,
      topCode.map(x => x[0]),
      topCode.map(x => x[1]),
      (label) => { els.currCodeFilter.value = (label === "(blank)") ? "" : label; applyAll(); }
    );

    chartSla = renderDonutChart(
      chartSla,
      els.chartSlaCanvas,
      slaLabels,
      slaData,
      ["#22c55e", "#f59e0b", "#ef4444", "#94a3b8", "#6366f1"]
    );

    chartAging = renderBarChart(
      chartAging,
      els.chartAgingCanvas,
      agingBuckets.map(b => b.label),
      agingData,
      () => {}
    );

    chartDiscipline = renderBarChart(
      chartDiscipline,
      els.chartDisciplineCanvas,
      topDiscipline.map(x => x[0]),
      topDiscipline.map(x => x
