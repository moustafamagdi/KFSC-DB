<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shop Drawings & Model Log — Dashboard</title>

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, Segoe UI, Arial; margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 14px 16px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 16px; font-weight: 650; }
    header .sub { opacity: .85; font-size: 12px; margin-top: 4px; }

    .wrap { padding: 14px 16px; }
    .row { display: grid; gap: var(--gap); }
    .row.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .row.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .row.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 1100px) { .row.cols-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 650px) { .row.cols-4, .row.cols-3, .row.cols-2 { grid-template-columns: 1fr; } }

    .card { background: #fff; border-radius: 14px; padding: 12px; box-shadow: 0 1px 8px rgba(0,0,0,.06); }
    .card h2 { margin: 0 0 10px; font-size: 13px; }
    .kpi { display: flex; align-items: baseline; gap: 10px; }
    .kpi .val { font-size: 26px; font-weight: 800; }
    .kpi .lbl { font-size: 12px; opacity: .75; }

    .controls { display: grid; gap: 10px; grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr; align-items: end; }
    @media (max-width: 1100px) { .controls { grid-template-columns: 1fr 1fr; } }
    .ctrl label { display: block; font-size: 11px; opacity: .7; margin-bottom: 6px; }
    .ctrl input, .ctrl select, .ctrl button {
      width: 100%; padding: 9px 10px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff;
      font-size: 13px;
    }
    .ctrl button { cursor: pointer; background: #111827; color: #fff; border: 0; }
    .ctrl button.secondary { background: #374151; }
    .hint { font-size: 12px; opacity: .7; margin-top: 8px; }

    canvas { width: 100% !important; height: 260px !important; }

    #table { border-radius: 12px; overflow: hidden; }
    .small { font-size: 12px; opacity: .75; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; background: #eef2ff; font-size: 11px; }
    .danger { background: #fee2e2; }
    .warn { background: #fef3c7; }
    .ok { background: #dcfce7; }

    .footer { margin-top: 10px; font-size: 12px; opacity: .75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>

<body>
<header>
  <h1>Shop Drawings & Model Log — Interactive Dashboard</h1>
  <div class="sub">Upload your CSV anytime to refresh analytics • Filters + Charts + Table • Header auto-detect for your export format</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="controls">
      <div class="ctrl">
        <label>Upload CSV</label>
        <input id="fileInput" type="file" accept=".csv" />
      </div>

      <div class="ctrl">
        <label>Quick Search (Drawing No / Description / Workflow)</label>
        <input id="searchBox" type="text" placeholder="Type to filter..." />
      </div>

      <div class="ctrl">
        <label>Level</label>
        <select id="levelFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Zone</label>
        <select id="zoneFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Status-VP</label>
        <select id="statusVpFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Discipline</label>
        <select id="disciplineFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Curr. Code</label>
        <select id="currCodeFilter"><option value="">All</option></select>
      </div>

      <div class="ctrl">
        <label>Actions</label>
        <div style="display:flex; gap:10px;">
          <button id="resetBtn" class="secondary" type="button">Reset Filters</button>
          <button id="exportBtn" type="button">Export Filtered CSV</button>
        </div>
        <div class="hint">If Edge blocks storage, auto-load is disabled (no impact on loading CSV).</div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="row cols-4">
    <div class="card">
      <h2>KPIs</h2>
      <div class="kpi"><div class="val" id="kpiTotal">—</div><div class="lbl">Total rows</div></div>
      <div class="kpi"><div class="val" id="kpiSubmitted">—</div><div class="lbl">With Workflow No.</div></div>
      <div class="kpi"><div class="val" id="kpiCodeB">—</div><div class="lbl">Curr. Code = B</div></div>
      <div class="kpi"><div class="val" id="kpiCodeC">—</div><div class="lbl">Curr. Code = C</div></div>
      <div class="kpi"><div class="val" id="kpiNotStarted">—</div><div class="lbl">Status-VP contains "Not Started"</div></div>
      <div class="footer small">KPIs are based on current filters.</div>
    </div>

    <div class="card">
      <h2>Distribution — Status-VP</h2>
      <canvas id="chartStatus"></canvas>
      <div class="small">Top 10 only.</div>
    </div>

    <div class="card">
      <h2>Distribution — Current Code</h2>
      <canvas id="chartCode"></canvas>
      <div class="small">Top 10 only.</div>
    </div>

    <div class="card">
      <h2>Heatmap — Level × Zone</h2>
      <div id="heatmap" class="small">Upload CSV to render…</div>
      <div class="footer small">Fast way to spot workload concentration.</div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <h2>Interactive Table</h2>
    <div class="small">Search, filter, sort, group, and export the filtered rows.</div>
    <div style="height:10px"></div>
    <div id="table"></div>
    <div class="footer small" id="loadInfo"></div>
  </div>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // ---------- Helpers ----------
  const LS_KEY = "shopdrawings_last_csv_text_v2";

  function norm(v){
    if(v === null || v === undefined) return "";
    const s = String(v).trim();
    if(s === "-" || s === "NaN" || s === "nan") return "";
    return s;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function uniqSorted(arr){
    return [...new Set(arr.filter(x => x !== ""))].sort((a,b) => a.localeCompare(b, undefined, {numeric:true, sensitivity:"base"}));
  }

  function countBy(rows, key){
    const m = new Map();
    rows.forEach(r => {
      const k = norm(r[key]) || "(blank)";
      m.set(k, (m.get(k)||0) + 1);
    });
    return [...m.entries()].sort((a,b) => b[1]-a[1]);
  }

  function setSelectOptions(selectEl, values){
    const current = selectEl.value;
    selectEl.innerHTML = `<option value="">All</option>` + values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    selectEl.value = values.includes(current) ? current : "";
  }

  function pill(text, cls){
    return `<span class="pill ${cls||""}">${escapeHtml(text)}</span>`;
  }

  // ---------- State ----------
  let rawRows = [];
  let filteredRows = [];
  let table = null;
  let chartStatus = null;
  let chartCode = null;

  const els = {
    fileInput: document.getElementById("fileInput"),
    searchBox: document.getElementById("searchBox"),
    levelFilter: document.getElementById("levelFilter"),
    zoneFilter: document.getElementById("zoneFilter"),
    statusVpFilter: document.getElementById("statusVpFilter"),
    disciplineFilter: document.getElementById("disciplineFilter"),
    currCodeFilter: document.getElementById("currCodeFilter"),
    resetBtn: document.getElementById("resetBtn"),
    exportBtn: document.getElementById("exportBtn"),
    loadInfo: document.getElementById("loadInfo"),

    kpiTotal: document.getElementById("kpiTotal"),
    kpiSubmitted: document.getElementById("kpiSubmitted"),
    kpiCodeB: document.getElementById("kpiCodeB"),
    kpiCodeC: document.getElementById("kpiCodeC"),
    kpiNotStarted: document.getElementById("kpiNotStarted"),

    heatmap: document.getElementById("heatmap"),
    chartStatusCanvas: document.getElementById("chartStatus"),
    chartCodeCanvas: document.getElementById("chartCode"),
  };

  // ---------- Header auto-detect for your export ----------
  function detectHeaderRow(lines){
    const mustHave = ["S.N.", "Drawing No.", "Description"];
    const shouldHave = ["Level", "Zone", "Discipline", "Status-VP", "Curr. Code", "Workflow No."];

    for(let i=0; i<Math.min(lines.length, 120); i++){
      const line = lines[i] || "";
      const mustHits = mustHave.filter(h => line.includes(h)).length;
      const shouldHits = shouldHave.filter(h => line.includes(h)).length;
      if(mustHits === mustHave.length && shouldHits >= 2){
        return i;
      }
    }
    return -1;
  }

  function makeHeadersUnique(fields){
    const seen = new Map();
    return (fields || []).map((f, idx) => {
      const base = norm(f) || `Unnamed_${idx}`;
      const key = base.toLowerCase();
      const n = (seen.get(key) || 0) + 1;
      seen.set(key, n);
      return n === 1 ? base : `${base} (${n})`;
    });
  }

  function normalizeRowKeys(row){
    const out = {};
    Object.keys(row).forEach(k => {
      const nk = (k || "").trim();
      out[nk] = row[k];
    });
    return out;
  }

  // ---------- Load CSV ----------
  function loadCsvText(csvText){
    try { localStorage.setItem(LS_KEY, csvText); } catch(e) {}

    const lines = csvText.split(/\r?\n/);
    const headerIndex = detectHeaderRow(lines);

    if(headerIndex === -1){
      alert("Header row not found. Your CSV export contains pre-header lines; please ensure it includes 'S.N., Drawing No., Description, ...'");
      console.log("First 30 lines:", lines.slice(0,30));
      return;
    }

    const cleanCsv = lines.slice(headerIndex).join("\n");
    console.log("Detected header row at line:", headerIndex + 1);

    Papa.parse(cleanCsv, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
      complete: (results) => {
        const rawFields = results.meta?.fields || [];
        const uniqueFields = makeHeadersUnique(rawFields);

        // Re-map rows to unique field names (Papa uses raw fields as keys)
        rawRows = (results.data || []).map(r => {
          const out = {};
          rawFields.forEach((f, i) => out[uniqueFields[i]] = r[f]);
          return normalizeRowKeys(out);
        });

        // Filter out completely empty rows (export has blank separators)
        rawRows = rawRows.filter(r => Object.values(r).some(v => norm(v)));

        // Build UI + table AFTER data exists (avoid Tabulator init crash)
        buildUIFromData(uniqueFields);
        applyAll();

        els.loadInfo.innerHTML =
          `Loaded <b>${rawRows.length.toLocaleString()}</b> rows • Header detected at line <b>${headerIndex+1}</b>.`;
      },
      error: (err) => {
        alert("CSV parse error: " + err);
        console.error(err);
      }
    });
  }

  // ---------- Build UI (and rebuild table safely) ----------
  function buildUIFromData(allKeys){
    const levels = uniqSorted(rawRows.map(r => norm(r["Level"])));
    const zones = uniqSorted(rawRows.map(r => norm(r["Zone"])));
    const statusVp = uniqSorted(rawRows.map(r => norm(r["Status-VP"])));
    const discs = uniqSorted(rawRows.map(r => norm(r["Discipline"])));
    const codes = uniqSorted(rawRows.map(r => norm(r["Curr. Code"])));

    setSelectOptions(els.levelFilter, levels);
    setSelectOptions(els.zoneFilter, zones);
    setSelectOptions(els.statusVpFilter, statusVp);
    setSelectOptions(els.disciplineFilter, discs);
    setSelectOptions(els.currCodeFilter, codes);

    const preferred = [
      "S.N.", "Drawing No.", "Description", "Stage", "Building", "Discipline", "Sub-Discipline",
      "Level", "Zone", "Part", "Sub_Part", "Status-SBG", "Status-VP",
      "Curr. Code", "Curr. Code Date", "Curr. Code Rev", "Workflow No.", "Remarks"
    ];

    const colsOrdered = preferred.filter(c => allKeys.includes(c))
      .concat(allKeys.filter(k => !preferred.includes(k)));

    const tabCols = colsOrdered.map(c => ({
      title: c,
      field: c,
      hozAlign: "left",
      widthGrow: 2,
      formatter: (cell) => {
        const v = norm(cell.getValue());
        if(!v) return "";
        if(c === "Curr. Code"){
          const cls = v === "C" ? "danger" : (v === "B" ? "warn" : (v === "QA" ? "ok" : ""));
          return pill(v, cls);
        }
        if(c === "Status-VP"){
          const low = v.toLowerCase();
          if(low.includes("not started")) return pill(v, "danger");
          if(low.includes("on hold")) return pill(v, "warn");
          if(v === "B") return pill("B", "warn");
          if(v === "C") return pill("C", "danger");
        }
        return escapeHtml(v);
      }
    }));

    // Destroy and recreate table every load to avoid "not initialized" + column mismatch bugs
    if(table){
      table.destroy();
      table = null;
    }

    table = new Tabulator("#table", {
      data: [],               // set after tableBuilt
      columns: tabCols,
      layout: "fitDataStretch",
      height: "520px",
      pagination: true,
      paginationSize: 25,
      movableColumns: true,
      resizableColumnFit: true,
      placeholder: "No data (check filters)…",
    });

    // Guarantee setData happens only after Tabulator is ready
    table.on("tableBuilt", () => {
      updateTable();
    });
  }

  // ---------- Filters ----------
  function applyAll(){
    const q = norm(els.searchBox.value).toLowerCase();
    const fLevel = norm(els.levelFilter.value);
    const fZone = norm(els.zoneFilter.value);
    const fStatusVp = norm(els.statusVpFilter.value);
    const fDisc = norm(els.disciplineFilter.value);
    const fCode = norm(els.currCodeFilter.value);

    filteredRows = rawRows.filter(r => {
      if(fLevel && norm(r["Level"]) !== fLevel) return false;
      if(fZone && norm(r["Zone"]) !== fZone) return false;
      if(fStatusVp && norm(r["Status-VP"]) !== fStatusVp) return false;
      if(fDisc && norm(r["Discipline"]) !== fDisc) return false;
      if(fCode && norm(r["Curr. Code"]) !== fCode) return false;

      if(q){
        const hay = [
          r["Drawing No."], r["Description"], r["Workflow No."],
          r["Workflow No. (01)"], r["Workflow No. (02)"],
          r["Status-VP"], r["Status-SBG"], r["Remarks"]
        ].map(norm).join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    updateKPIs();
    updateCharts();
    updateHeatmap();
    updateTable();
  }

  // ---------- KPIs ----------
  function updateKPIs(){
    const rows = filteredRows;
    const total = rows.length;

    const withWF = rows.filter(r => norm(r["Workflow No."]) || norm(r["Workflow No. (01)"]) || norm(r["Workflow No. (02)"])).length;
    const codeB = rows.filter(r => norm(r["Curr. Code"]) === "B").length;
    const codeC = rows.filter(r => norm(r["Curr. Code"]) === "C").length;
    const notStarted = rows.filter(r => norm(r["Status-VP"]).toLowerCase().includes("not started")).length;

    els.kpiTotal.textContent = total.toLocaleString();
    els.kpiSubmitted.textContent = withWF.toLocaleString();
    els.kpiCodeB.textContent = codeB.toLocaleString();
    els.kpiCodeC.textContent = codeC.toLocaleString();
    els.kpiNotStarted.textContent = notStarted.toLocaleString();
  }

  // ---------- Charts ----------
  function renderBarChart(chartRef, canvas, labels, data, title){
    if(chartRef) chartRef.destroy();
    return new Chart(canvas, {
      type: "bar",
      data: { labels, datasets: [{ label: title, data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function updateCharts(){
    if(!filteredRows.length) return;

    const topStatus = countBy(filteredRows, "Status-VP").slice(0,10);
    const topCode = countBy(filteredRows, "Curr. Code").slice(0,10);

    chartStatus = renderBarChart(chartStatus, els.chartStatusCanvas,
      topStatus.map(x => x[0]), topStatus.map(x => x[1]), "Status-VP"
    );
    chartCode = renderBarChart(chartCode, els.chartCodeCanvas,
      topCode.map(x => x[0]), topCode.map(x => x[1]), "Curr. Code"
    );
  }

  // ---------- Heatmap ----------
  function updateHeatmap(){
    const rows = filteredRows;
    const levels = uniqSorted(rows.map(r => norm(r["Level"])));
    const zones = uniqSorted(rows.map(r => norm(r["Zone"])));

    if(levels.length === 0 || zones.length === 0){
      els.heatmap.innerHTML = "No data after filtering.";
      return;
    }

    const m = {};
    levels.forEach(L => { m[L] = {}; zones.forEach(Z => m[L][Z] = 0); });
    rows.forEach(r => {
      const L = norm(r["Level"]), Z = norm(r["Zone"]);
      if(L && Z && m[L] && m[L][Z] !== undefined) m[L][Z] += 1;
    });

    const max = Math.max(...levels.flatMap(L => zones.map(Z => m[L][Z])));

    let html = `<div style="overflow:auto"><table style="border-collapse:collapse; width:100%; font-size:12px">`;
    html += `<tr><th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb">Level \\ Zone</th>`;
    zones.forEach(Z => html += `<th style="text-align:center; padding:6px; border-bottom:1px solid #e5e7eb">${escapeHtml(Z)}</th>`);
    html += `</tr>`;

    levels.forEach(L => {
      html += `<tr><td style="padding:6px; border-bottom:1px solid #f1f5f9"><b>${escapeHtml(L)}</b></td>`;
      zones.forEach(Z => {
        const v = m[L][Z];
        const intensity = max ? Math.round((v / max) * 80) : 0;
        html += `<td style="
          text-align:center; padding:6px; border-bottom:1px solid #f1f5f9;
          background: rgba(17,24,39, ${intensity/100});
          color: ${intensity>40 ? "#fff" : "#111"};
          border-radius:8px;">
          ${v}
        </td>`;
      });
      html += `</tr>`;
    });
    html += `</table></div>`;
    els.heatmap.innerHTML = html;
  }

  // ---------- Table ----------
  function updateTable(){
    if(!table) return;
    // If table not built yet, tableBuilt handler will call updateTable again.
    try { table.setData(filteredRows); } catch(e) { console.warn("setData skipped:", e); }
  }

  // ---------- Export filtered ----------
  function csvEscape(v){
    const s = (v === null || v === undefined) ? "" : String(v);
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
    return s;
  }

  function exportFilteredCsv(){
    if(filteredRows.length === 0){
      alert("No rows to export (filters removed everything).");
      return;
    }
    const cols = Object.keys(filteredRows[0]);
    const lines = [];
    lines.push(cols.map(csvEscape).join(","));
    filteredRows.forEach(r => lines.push(cols.map(c => csvEscape(r[c])).join(",")));

    const blob = new Blob([lines.join("\n")], {type: "text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "filtered_shopdrawings.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------- Events ----------
  els.fileInput.addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => loadCsvText(String(reader.result || ""));
    reader.readAsText(f);
  });

  ["input","change"].forEach(ev => {
    els.searchBox.addEventListener(ev, applyAll);
    els.levelFilter.addEventListener(ev, applyAll);
    els.zoneFilter.addEventListener(ev, applyAll);
    els.statusVpFilter.addEventListener(ev, applyAll);
    els.disciplineFilter.addEventListener(ev, applyAll);
    els.currCodeFilter.addEventListener(ev, applyAll);
  });

  els.resetBtn.addEventListener("click", () => {
    els.searchBox.value = "";
    els.levelFilter.value = "";
    els.zoneFilter.value = "";
    els.statusVpFilter.value = "";
    els.disciplineFilter.value = "";
    els.currCodeFilter.value = "";
    applyAll();
  });

  els.exportBtn.addEventListener("click", exportFilteredCsv);

  // ---------- Boot (auto-load last csv if storage is allowed) ----------
  (function boot(){
    try {
      const last = localStorage.getItem(LS_KEY);
      if(last && last.length > 100) loadCsvText(last);
    } catch (e) {
      console.warn("Storage blocked by browser privacy settings. Auto-load disabled.");
    }
  })();
</script>
</body>
</html>
